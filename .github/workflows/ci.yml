name: CI Build

on:
    push:
        branches:
            - 'feat/**'
            - 'fix/**'
            - 'design/**'
            - 'refactor/**'
            - 'ci/**'
            - 'setting/**'
            - 'docs/**'
            - 'chore/**'
            - 'test/**'
    pull_request:
        branches:
            - main

permissions:
    contents: read
    pull-requests: write
    checks: write

jobs:
    ci-pipeline:
        name: Code Quality Pipeline
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24.11.1'

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ”· Build / Type Check
              id: build
              run: pnpm run build
              continue-on-error: true
              env:
                  FORCE_COLOR: 3

            - name: ðŸ” ESLint Check
              id: lint
              run: |
                  set -o pipefail
                  pnpm run lint | tee lint-result
              continue-on-error: true
              env:
                  FORCE_COLOR: 3

            - name: ðŸŽ¨ Format Check
              id: format
              run: |
                  set -o pipefail
                  pnpm run prettier | tee format-result
              continue-on-error: true
              env:
                  FORCE_COLOR: 3

            - name: Generate Results Summary
              if: always()
              run: |
                  echo "## ðŸš€ CI Check Results" > summary.md
                  echo "" >> summary.md
                  echo "| Check Item | Status |" >> summary.md
                  echo "|------------|--------|" >> summary.md

                  if [ "${{ steps.build.outcome }}" == "success" ]; then
                    echo "| ðŸ”· **Build/Type Check** | âœ… Pass |" >> summary.md
                  else
                    echo "| ðŸ”· **Build/Type Check** | âŒ Fail |" >> summary.md
                  fi

                  if [ "${{ steps.lint.outcome }}" == "success" ]; then
                    echo "| ðŸ” **ESLint** | âœ… Pass |" >> summary.md
                  else
                    echo "| ðŸ” **ESLint** | âŒ Fail |" >> summary.md
                  fi

                  if [ "${{ steps.format.outcome }}" == "success" ]; then
                    echo "| ðŸŽ¨ **Format** | âœ… Pass |" >> summary.md
                  else
                    echo "| ðŸŽ¨ **Format** | âŒ Fail |" >> summary.md
                  fi

                  echo "" >> summary.md
                  echo "ðŸ“‹ [View Full Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> summary.md

            - name: Comment on PR
              if: github.event_name == 'pull_request'
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  body-path: summary.md

            - name: Final Failure Check
              if: steps.build.outcome == 'failure' || steps.lint.outcome == 'failure' || steps.format.outcome == 'failure'
              run: |
                  echo "One or more required checks failed."
                  exit 1
